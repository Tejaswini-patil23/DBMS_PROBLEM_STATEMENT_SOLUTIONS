CREATE TABLE Borrower (
    rollin        NUMBER(5),
    name          VARCHAR2(30),
    dateofissue   DATE,
    nameofbook    VARCHAR2(50),
    status        CHAR(1)   -- 'I' for Issued, 'R' for Returned
);

CREATE TABLE Fine (
    roll_no  NUMBER(5),
    fine_date DATE,
    amt      NUMBER(10)
);

INSERT INTO Borrower VALUES (1, 'Teju', TO_DATE('10-OCT-2025','DD-MON-YYYY'), 'DBMS', 'I');
INSERT INTO Borrower VALUES (2, 'Riya', TO_DATE('20-OCT-2025','DD-MON-YYYY'), 'CN', 'I');
INSERT INTO Borrower VALUES (3, 'Amit', TO_DATE('25-OCT-2025','DD-MON-YYYY'), 'OS', 'I');

COMMIT;

DECLARE
    v_roll       NUMBER(5);
    v_book       VARCHAR2(50);
    v_issue_date DATE;
    v_days       NUMBER;
    v_fine_amt   NUMBER := 0;
BEGIN
    -- 1️⃣ Accept user input
    v_roll := &roll;
    v_book := '&bookname';

    -- 2️⃣ Fetch the issue date for that student and book
    SELECT dateofissue
    INTO v_issue_date
    FROM borrower
    WHERE rollin = v_roll AND nameofbook = v_book;

    -- 3️⃣ Calculate number of days since issue
    v_days := TRUNC(SYSDATE - v_issue_date);

    DBMS_OUTPUT.PUT_LINE('Book issued ' || v_days || ' days ago.');

    -- 4️⃣ Determine fine amount based on days
    IF v_days BETWEEN 15 AND 30 THEN
        v_fine_amt := v_days * 5;
    ELSIF v_days > 30 THEN
        v_fine_amt := (30 * 5) + ((v_days - 30) * 50);
    ELSE
        v_fine_amt := 0;
    END IF;

    -- 5️⃣ Update status to Returned (R)
    UPDATE borrower
    SET status = 'R'
    WHERE rollin = v_roll AND nameofbook = v_book;

    -- 6️⃣ If fine applies, insert record into Fine table
    IF v_fine_amt > 0 THEN
        INSERT INTO fine (roll_no, fine_date, amt)
        VALUES (v_roll, SYSDATE, v_fine_amt);

        DBMS_OUTPUT.PUT_LINE('Fine imposed: Rs ' || v_fine_amt);
    ELSE
        DBMS_OUTPUT.PUT_LINE('No fine. Book returned on time.');
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Error: No record found for given roll number and book name.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/


